<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<title>Halo</title>
<style>
body { font-family: arial; margin: 0; overflow: hidden; background: #444444; text-align: center; padding-right: 50%;}
canvas { margin: 20px 0 10px 0; border: 10px solid black;}
a { color: white; }
#bigHalo {
    height: 100%;
    position: absolute;
    top: 0;
    right: 0;
    width: 50%;
}
#info {
    color: white;
    text-align: left;
    margin-left: 30%;
    line-height: 150%;
}
</style>
</head>
<body>
<br/>
<br/>
<a href="javascript:showDay('crtn1')">crtn1</a>
<a href="javascript:showDay('crtn2')">crtn2</a>
<a href="javascript:showDay('crtn3')">crtn3</a>
<a href="javascript:showDay('crtn4')">crtn4</a>
<a href="javascript:showDay('crtn5')">crtn5</a>
<a href="javascript:showDay('stephen1')">stephen 27th</a>
<a href="javascript:showDay('stephen2')">stephen 29th</a>
<br/>
<canvas width="1280" height="200" id="graph"></canvas>
<div id="info">bla</div>
<script src="main.web.js"></script>
<script src="app-mayo/mayo-halo-controller.js"></script>
<script src="data/mayo-data.js"></script>
<script src="data/export-stephen-2016-04-27.js"></script>
<script src="data/export-stephen-2016-04-29.js"></script>
<!--<iframe src="index.html" frameborder="0" id="bigHalo"></iframe>-->
<script>

function showDay(dayId) {
    document.location.hash = dayId;
    document.location.reload();
}

function remap(n, oldmin, oldmax, newmin, newmax) {
    return newmin + (n - oldmin) / (oldmax - oldmin) * (newmax - newmin)
}

/*
MetricInterval
cdist: 0
deviceOn: true
dist: 0
flights: 0
hcount: 0
heart: "-"
htot: 0
kcal: 0.045
label: "21:00"
met: 0.0007142857142857143
steps: 0
stood: 0
 */

window.addEventListener('load', function() {
    var dayId = 'crtn4';
    var timeIndex = 0;
    if (document.location.hash.length > 0) {
        var tokens = document.location.hash.substr(1).split(':');
        dayId = tokens[0];
        timeIndex = parseInt(tokens[1]);
    }
    var day = window[dayId];
    MayoController.setHistoricalView(true)
    day.data.forEach(function(d) {
        d.date = new Date(d.time)
    })

    day.data.sort(function(a, b) {
        return (a.date.getTime() - b.date.getTime());
    })
    console.log('day', day, day.data.length);
    day.data.forEach(function(d) {
        console.log(d.date);
    });

    MayoController.setUserData(day.user.birthdate, day.user.height, day.user.weight, day.user.gender);
    MayoController.resetHKData(day.data);
    MayoController.setDisplayMode('stratified');

    var model = MayoController.getModel();
    var canvas = document.getElementById('graph');
    var ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth - 100;
    var W = canvas.width;
    var H = canvas.height - 20;

    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, W, H + 20);

    ctx.fillStyle = '#FFFFFF';
    ctx.fillText(dayId, 10, 10)

    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        if (i % 6 == 0) {

            ctx.fillText(metric.label, remap(i, 0, 144, 0, W), H - 10)
        }
    }

    //STEPS GRAPH
    ctx.fillStyle = '#00FF00';
    ctx.fillText('STEPS', 10, 30)
    ctx.strokeStyle = '#00FF00';
    ctx.beginPath();
    var totalSteps = 0;
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        totalSteps += metric.steps;
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(totalSteps, 0, 20000, H - 30, 10) //14000 max num steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //HR GRAPH
    ctx.fillStyle = '#ff0000';
    ctx.fillText('HR Ora', 10, 50)
    ctx.strokeStyle = '#ff0000';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(metric.heart, 0, 180, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //HR GRAPH
    ctx.fillStyle = '#ff00ff';
    ctx.fillText('HR HK', 70, 50)
    ctx.strokeStyle = '#ff00ff';
    ctx.beginPath();
    ctx.moveTo(0, H - 30 - 2);
    for(var i=0; i<day.data.length; i++) {
        var reading = day.data[i];
        if (reading.type != "HKQuantityTypeIdentifierHeartRate") continue;
        var date = new Date(reading.time);
        var h = date.getHours();
        var m = date.getMinutes();
        var t = (h + m/60)/24;
        var x = remap(t, 0, 1, 0, W); //24h * 6 readings @ every 10min
        var y = remap(reading.value, 0, 180, H - 30, 10) + 2 //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //COMPLEXITY GRAPH
    ctx.fillStyle = '#FFFF00';
    ctx.fillText('COMPLEXITY', 10, 70)
    ctx.strokeStyle = '#FFFF00';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(view.halo.complexity, 0, 1, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //SIZE GRAPH
    ctx.fillStyle = '#4444FF';
    ctx.fillText('SIZE', 60, 30)
    ctx.strokeStyle = '#4444FF';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(view.halo.size, 0, 1, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //COLOR GRAPH
    ctx.fillStyle = '#FFFFFF';
    ctx.fillText('COLOR', 10, 90)
    ctx.strokeStyle = '#FFFFFF';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        console.log(view.halo.color);
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(view.halo.color, 0, 1, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //COLOR CENTER GRAPH
    ctx.fillStyle = '#AAAAAA';
    ctx.fillText('CENTER', 50, 90)
    ctx.strokeStyle = '#AAAAAA';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        console.log(view.halo.colorCenter);
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(Math.max(0,view.halo.colorCenter), 0, 1, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //COLOR CENTER GRAPH
    ctx.fillStyle = '#FF9900';
    ctx.fillText('RATIO', 100, 90)
    ctx.strokeStyle = '#FF9900';
    ctx.beginPath();
    ctx.moveTo(0, H - 30);
    for(var i=0; i<model.length; i++) {
        var metric = model[i];
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        console.log(view.halo.colorCenterRatio);
        var x = remap(i, 0, 144, 0, W); //24h * 6 readings @ every 10min
        var y = remap(Math.max(0,view.halo.colorCenterRatio), 0, 1, H - 30, 10) //180 max hr steps per day
        ctx.lineTo(x, y)
    }
    ctx.stroke();

    //144, 24h * 10min intervals
    console.log('model', MayoController.getModel().length)
    console.log('model', MayoController.getModel()[0])
    console.log('model', MayoController.getModel()[1])
    console.log('model', MayoController.getModel()[2])

    //wait for halo to initialize, ideally there would be a callback
    setTimeout(function() {
        updateAtX(W/2)
    }, 500)

    canvas.addEventListener('click', function(e) {
        console.log('layerX', e.layerX, 'clientX', e.clientX)
        var x = e.layerX - 10; //border
        updateAtX(x)
    })

    function updateAtX(x) {
        var t = x / W;
        var time = Math.floor(t * 24) + ':' + ((t * 24 - Math.floor(t * 24)) * 60 | 0);
        var i = 144 * t | 0;
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, H, W, 20);
        ctx.strokeStyle = '#FFFFFF'
        ctx.beginPath();
        ctx.moveTo(x, H - 0)
        ctx.lineTo(x, H + 20)
        ctx.stroke();
        MayoController.setTimeIndex(i);
        var view = MayoController.getView();
        var state = MayoController.getState();
        console.log(state)
        document.getElementById('info').innerHTML =
            ['totalSteps:',
            state.totalSteps, '<br/>',
            'currentHeartRate:', state.currentHeartRate, ', ',
            'complexity:', Math.floor(view.halo.complexity*100)/100, ', ',
            'color:', Math.floor(view.halo.color*100)/100, ', ',
            'colorCenter:', Math.floor(view.halo.colorCenter*100)/100, ', ',
            'colorCenterRatio:', Math.floor(view.halo.colorCenterRatio*100)/100, ', ',
            'size:', Math.floor(view.halo.size*100)/100, ', ',
            'time:' + time ].join(' ')

    }
})
</script>
</body>
</html>
